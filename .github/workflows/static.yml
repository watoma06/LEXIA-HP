# LEXIA-HP ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ - æœ€é©åŒ–ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: ğŸš€ Deploy LEXIA-HP Website

on:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å®Ÿè¡Œ
  push:
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - 'PROJECT.md'
      - '.github/**'
      - 'calculator/build-wasm.*'
      - 'calculator/*.md'

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã« GITHUB_TOKEN ã®æ¨©é™ã‚’è¨­å®š
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  issues: write

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '18'

jobs:
  # ===================================
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ & ãƒ†ã‚¹ãƒˆ
  # ===================================
  quality-check:
    name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
          format: text
          
      - name: ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        run: |
          echo "## ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          # CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          css_size=$(stat -c%s "style.css")
          css_mb=$(echo "scale=2; $css_size/1024/1024" | bc -l)
          if (( $(echo "$css_size > 500000" | bc -l) )); then
            echo "| style.css | ${css_mb}MB | âš ï¸ å¤§ãã„ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| style.css | ${css_mb}MB | âœ… è‰¯å¥½ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # JSãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          for js_file in script.js calculator/lexia-price-calculator.js; do
            if [ -f "$js_file" ]; then
              js_size=$(stat -c%s "$js_file")
              js_mb=$(echo "scale=2; $js_size/1024/1024" | bc -l)
              if (( $(echo "$js_size > 300000" | bc -l) )); then
                echo "| $js_file | ${js_mb}MB | âš ï¸ å¤§ãã„ |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $js_file | ${js_mb}MB | âœ… è‰¯å¥½ |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: ğŸ”— ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --verbose --no-progress './**/*.html' './**/*.md'
          fail: false
        continue-on-error: true

  # ===================================
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
  # ===================================
  optimize:
    name: âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    runs-on: ubuntu-latest
    needs: quality-check
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        id: cache-key
        run: |
          key="optimized-${{ hashFiles('*.html', '*.css', '*.js', 'calculator/*.js') }}"
          echo "key=$key" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ æœ€é©åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ./optimized
          key: ${{ steps.cache-key.outputs.key }}

      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: âš¡ CSS/JSæœ€é©åŒ–
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p optimized
          
          # æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g cssnano-cli terser
          
          # CSSæœ€é©åŒ–
          echo "ğŸ¨ CSSæœ€é©åŒ–ä¸­..."
          cssnano style.css optimized/style.min.css
          
          # JavaScriptæœ€é©åŒ–
          echo "âš¡ JavaScriptæœ€é©åŒ–ä¸­..."
          terser script.js -o optimized/script.min.js -c -m
          terser calculator/lexia-price-calculator.js -o optimized/lexia-price-calculator.min.js -c -m
          
          # HTMLã‚’æœ€é©åŒ–ç‰ˆã«æ›´æ–°
          echo "ğŸ“ HTMLæ›´æ–°ä¸­..."
          cp *.html optimized/
          
          # CSS/JSãƒ‘ã‚¹ã‚’æœ€é©åŒ–ç‰ˆã«ç½®æ›
          cd optimized
          sed -i 's/style\.css/style.min.css/g' *.html
          sed -i 's/script\.js/script.min.js/g' *.html
          sed -i 's/calculator\/lexia-price-calculator\.js/lexia-price-calculator.min.js/g' *.html
          
          # è¨ˆç®—æ©Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆæœ€é©åŒ–ç‰ˆä»¥å¤–ï¼‰
          cp -r ../calculator .
          rm -f calculator/lexia-price-calculator.js # æœ€é©åŒ–ç‰ˆã‚’ä½¿ç”¨
          
          # æœ€é©åŒ–çµæœãƒ¬ãƒãƒ¼ãƒˆ
          echo "## âš¡ æœ€é©åŒ–çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | å…ƒã‚µã‚¤ã‚º | æœ€é©åŒ–å¾Œ | å‰Šæ¸›ç‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          original_css=$(stat -c%s "../style.css")
          optimized_css=$(stat -c%s "style.min.css")
          css_reduction=$(echo "scale=1; (($original_css - $optimized_css) * 100) / $original_css" | bc -l)
          echo "| style.css | ${original_css}B | ${optimized_css}B | ${css_reduction}% |" >> $GITHUB_STEP_SUMMARY
          
          original_js=$(stat -c%s "../script.js")
          optimized_js=$(stat -c%s "script.min.js")
          js_reduction=$(echo "scale=1; (($original_js - $optimized_js) * 100) / $original_js" | bc -l)
          echo "| script.js | ${original_js}B | ${optimized_js}B | ${js_reduction}% |" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        with:
          name: optimized-site
          path: ./optimized
          retention-days: 30

  # ===================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ===================================
  security:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” æ©Ÿå¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # ===================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤
  # ===================================
  deploy:
    name: ğŸš€ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [quality-check, optimize, security]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./deploy

      - name: ğŸ› ï¸ Pagesè¨­å®š
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Pagesã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: ğŸš€ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
        run: |
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆPRã®å ´åˆï¼‰
  # ===================================
  preview-deploy:
    name: ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [quality-check, optimize]
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./preview

      - name: ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†
            
            ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${{ github.event.number }} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæº–å‚™ã§ãã¾ã—ãŸã€‚
            
            ### ğŸ“Š å¤‰æ›´å†…å®¹
            - ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.event.pull_request.head.sha }}\`
            - ãƒ–ãƒ©ãƒ³ãƒ: \`${{ github.event.pull_request.head.ref }}\`
            
            ### âœ… å“è³ªãƒã‚§ãƒƒã‚¯çµæœ
            - HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å®Œäº†
            - ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯: å®Œäº†  
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: å®Œäº†
            
            ãƒãƒ¼ã‚¸å¾Œã€æœ¬ç•ªã‚µã‚¤ãƒˆã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
