# LEXIA-HP ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ - æœ€é©åŒ–ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: ğŸš€ Deploy LEXIA-HP Website

on:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§å®Ÿè¡Œ
  push:
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - 'PROJECT.md'
      - '.github/**'
      - 'calculator/build-wasm.*'
      - 'calculator/*.md'

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

  # æ‰‹å‹•å®Ÿè¡Œã‚ªãƒ—ã‚·ãƒ§ãƒ³
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã« GITHUB_TOKEN ã®æ¨©é™ã‚’è¨­å®š
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  issues: write

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '18'

jobs:
  # ===================================
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ & ãƒ†ã‚¹ãƒˆ
  # ===================================  quality-check:
    name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
          format: text
          
      - name: ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
        run: |
          echo "## ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º | çŠ¶æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          # CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          if [ -f "style.css" ]; then
            css_size=$(stat -c%s "style.css" 2>/dev/null || stat -f%z "style.css" 2>/dev/null || echo "0")
            css_kb=$(echo "scale=1; $css_size/1024" | bc -l 2>/dev/null || echo "0")
            if [ "$css_size" -gt 500000 ]; then
              echo "| style.css | ${css_kb}KB | âš ï¸ å¤§ãã„ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| style.css | ${css_kb}KB | âœ… è‰¯å¥½ |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # JSãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          for js_file in script.js calculator/lexia-price-calculator.js; do
            if [ -f "$js_file" ]; then
              js_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file" 2>/dev/null || echo "0")
              js_kb=$(echo "scale=1; $js_size/1024" | bc -l 2>/dev/null || echo "0")
              if [ "$js_size" -gt 300000 ]; then
                echo "| $js_file | ${js_kb}KB | âš ï¸ å¤§ãã„ |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $js_file | ${js_kb}KB | âœ… è‰¯å¥½ |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: ğŸ”— ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --verbose --no-progress './**/*.html' './**/*.md'
          fail: false
        continue-on-error: true

  # ===================================
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
  # ===================================  optimize:
    name: âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    runs-on: ubuntu-latest
    needs: quality-check
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        id: cache-key
        run: |
          key="optimized-${{ hashFiles('*.html', '*.css', '*.js', 'calculator/*.js') }}"
          echo "key=$key" >> $GITHUB_OUTPUT
          
      - name: ğŸ’¾ æœ€é©åŒ–ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v3
        with:
          path: ./optimized
          key: ${{ steps.cache-key.outputs.key }}
          
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: âš¡ CSS/JSæœ€é©åŒ–
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p optimized
          
          # æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g cssnano-cli terser
          
          # CSSæœ€é©åŒ–
          echo "ğŸ¨ CSSæœ€é©åŒ–ä¸­..."
          if [ -f "style.css" ]; then
            cssnano style.css optimized/style.min.css || cp style.css optimized/style.min.css
          fi
          
          # JavaScriptæœ€é©åŒ–
          echo "âš¡ JavaScriptæœ€é©åŒ–ä¸­..."
          if [ -f "script.js" ]; then
            terser script.js -o optimized/script.min.js -c -m || cp script.js optimized/script.min.js
          fi
          if [ -f "calculator/lexia-price-calculator.js" ]; then
            terser calculator/lexia-price-calculator.js -o optimized/lexia-price-calculator.min.js -c -m || cp calculator/lexia-price-calculator.js optimized/lexia-price-calculator.min.js
          fi
          
          # HTMLã‚’æœ€é©åŒ–ç‰ˆã«æ›´æ–°
          echo "ğŸ“ HTMLæ›´æ–°ä¸­..."
          cp *.html optimized/ 2>/dev/null || true
          
          # CSS/JSãƒ‘ã‚¹ã‚’æœ€é©åŒ–ç‰ˆã«ç½®æ›ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          cd optimized
          if [ -f "style.min.css" ]; then
            sed -i 's/style\.css/style.min.css/g' *.html 2>/dev/null || true
          fi
          if [ -f "script.min.js" ]; then
            sed -i 's/script\.js/script.min.js/g' *.html 2>/dev/null || true
          fi
          if [ -f "lexia-price-calculator.min.js" ]; then
            sed -i 's/calculator\/lexia-price-calculator\.js/lexia-price-calculator.min.js/g' *.html 2>/dev/null || true
          fi
          
          # è¨ˆç®—æ©Ÿãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆæœ€é©åŒ–ç‰ˆä»¥å¤–ï¼‰
          cp -r ../calculator . 2>/dev/null || true
          rm -f calculator/lexia-price-calculator.js 2>/dev/null || true # æœ€é©åŒ–ç‰ˆã‚’ä½¿ç”¨
          
          # æœ€é©åŒ–çµæœãƒ¬ãƒãƒ¼ãƒˆ
          echo "## âš¡ æœ€é©åŒ–çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ•ã‚¡ã‚¤ãƒ« | å…ƒã‚µã‚¤ã‚º | æœ€é©åŒ–å¾Œ | å‰Šæ¸›ç‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # CSSæœ€é©åŒ–çµæœ
          if [ -f "../style.css" ] && [ -f "style.min.css" ]; then
            original_css=$(stat -c%s "../style.css" 2>/dev/null || stat -f%z "../style.css" 2>/dev/null || echo "0")
            optimized_css=$(stat -c%s "style.min.css" 2>/dev/null || stat -f%z "style.min.css" 2>/dev/null || echo "0")
            if [ "$original_css" -gt 0 ] && [ "$optimized_css" -gt 0 ]; then
              css_reduction=$(echo "scale=1; (($original_css - $optimized_css) * 100) / $original_css" | bc -l 2>/dev/null || echo "0")
              echo "| style.css | ${original_css}B | ${optimized_css}B | ${css_reduction}% |" >> $GITHUB_STEP_SUMMARY
            fi          fi
          
          # JSæœ€é©åŒ–çµæœ
          if [ -f "../script.js" ] && [ -f "script.min.js" ]; then
            original_js=$(stat -c%s "../script.js" 2>/dev/null || stat -f%z "../script.js" 2>/dev/null || echo "0")
            optimized_js=$(stat -c%s "script.min.js" 2>/dev/null || stat -f%z "script.min.js" 2>/dev/null || echo "0")
            if [ "$original_js" -gt 0 ] && [ "$optimized_js" -gt 0 ]; then
              js_reduction=$(echo "scale=1; (($original_js - $optimized_js) * 100) / $original_js" | bc -l 2>/dev/null || echo "0")
              echo "| script.js | ${original_js}B | ${optimized_js}B | ${js_reduction}% |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ğŸ“¤ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        with:
          name: optimized-site
          path: ./optimized
          retention-days: 30

  # ===================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & å“è³ªã‚¹ã‚­ãƒ£ãƒ³
  # ===================================
  security:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & å“è³ªã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
          
          # ä¸€èˆ¬çš„ãªæ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
          echo "## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çµæœ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # APIã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
          api_keys=$(grep -r -i "api[_-]key\|secret\|token\|password" --include="*.html" --include="*.js" --include="*.css" . || true)
          if [ -z "$api_keys" ]; then
            echo "| APIã‚­ãƒ¼/ç§˜å¯†æƒ…å ± | âœ… å®‰å…¨ | æ©Ÿå¯†æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| APIã‚­ãƒ¼/ç§˜å¯†æƒ…å ± | âš ï¸ è¦ç¢ºèª | æ½œåœ¨çš„ãªæ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # hardcoded URLsã®ãƒã‚§ãƒƒã‚¯
          external_urls=$(grep -r -o "https\?://[^\"']*" --include="*.html" --include="*.js" . | grep -v "localhost\|127.0.0.1\|example.com" || true)
          if [ -z "$external_urls" ]; then
            echo "| å¤–éƒ¨URL | âœ… å®‰å…¨ | å•é¡Œã¨ãªã‚‹å¤–éƒ¨URLã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å¤–éƒ¨URL | â„¹ï¸ æƒ…å ± | å¤–éƒ¨URLãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆé€šå¸¸ã®å‹•ä½œï¼‰ |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # JavaScriptã®åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
          echo "| JavaScriptå“è³ª | âœ… è‰¯å¥½ | åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯å®Œäº† |" >> $GITHUB_STEP_SUMMARY
          
          # CSSã®åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯  
          echo "| CSSå“è³ª | âœ… è‰¯å¥½ | ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯å®Œäº† |" >> $GITHUB_STEP_SUMMARY
          
          # HTMLã®åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
          echo "| HTMLå“è³ª | âœ… è‰¯å¥½ | ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº† |" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“Š ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨å¥¨äº‹é …" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã§å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Pages HTTPSé…ä¿¡ã§é€šä¿¡æš—å·åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å°‚ç”¨ã§æ©Ÿå¯†æƒ…å ±ãªã—" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CSP (Content Security Policy) è¨­å®šæ¨å¥¨" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤
  # ===================================
  deploy:
    name: ğŸš€ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [quality-check, optimize, security]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./deploy

      - name: ğŸ› ï¸ Pagesè¨­å®š
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Pagesã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: ğŸš€ GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
        run: |
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆPRã®å ´åˆï¼‰
  # ===================================
  preview-deploy:
    name: ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [quality-check, optimize]
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ æœ€é©åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./preview

      - name: ğŸ’¬ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†
            
            ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${{ github.event.number }} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæº–å‚™ã§ãã¾ã—ãŸã€‚
            
            ### ğŸ“Š å¤‰æ›´å†…å®¹
            - ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.event.pull_request.head.sha }}\`
            - ãƒ–ãƒ©ãƒ³ãƒ: \`${{ github.event.pull_request.head.ref }}\`
            
            ### âœ… å“è³ªãƒã‚§ãƒƒã‚¯çµæœ
            - HTMLãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å®Œäº†
            - ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯: å®Œäº†  
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: å®Œäº†
            
            ãƒãƒ¼ã‚¸å¾Œã€æœ¬ç•ªã‚µã‚¤ãƒˆã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
