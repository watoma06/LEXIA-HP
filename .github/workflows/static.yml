# LEXIA-HP ウェブサイト - 最適化デプロイワークフロー
name: 🚀 Deploy LEXIA-HP Website

on:
  # デフォルトブランチへのプッシュで実行
  push:
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - 'PROJECT.md'
      - '.github/**'
      - 'calculator/build-wasm.*'
      - 'calculator/*.md'

  # プルリクエストでのプレビューデプロイ
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

  # 手動実行オプション
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'デプロイ環境を選択'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# GitHub Pages へのデプロイを許可するために GITHUB_TOKEN の権限を設定
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  issues: write

# 同時実行制御
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  NODE_VERSION: '18'

jobs:
  # ===================================
  # コード品質チェック & テスト
  # ===================================  quality-check:
    name: 🔍 コード品質チェック
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4
        
      - name: 🔍 HTMLバリデーション
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: ./
          format: text
          
      - name: 📊 ファイルサイズチェック
        run: |
          echo "## 📊 ファイルサイズ分析" >> $GITHUB_STEP_SUMMARY
          echo "| ファイル | サイズ | 状態 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          # CSSファイルサイズチェック
          if [ -f "style.css" ]; then
            css_size=$(stat -c%s "style.css" 2>/dev/null || stat -f%z "style.css" 2>/dev/null || echo "0")
            css_kb=$(echo "scale=1; $css_size/1024" | bc -l 2>/dev/null || echo "0")
            if [ "$css_size" -gt 500000 ]; then
              echo "| style.css | ${css_kb}KB | ⚠️ 大きい |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| style.css | ${css_kb}KB | ✅ 良好 |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # JSファイルサイズチェック
          for js_file in script.js calculator/lexia-price-calculator.js; do
            if [ -f "$js_file" ]; then
              js_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file" 2>/dev/null || echo "0")
              js_kb=$(echo "scale=1; $js_size/1024" | bc -l 2>/dev/null || echo "0")
              if [ "$js_size" -gt 300000 ]; then
                echo "| $js_file | ${js_kb}KB | ⚠️ 大きい |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $js_file | ${js_kb}KB | ✅ 良好 |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: 🔗 リンクチェック
        uses: lycheeverse/lychee-action@v1.8.0
        with:
          args: --verbose --no-progress './**/*.html' './**/*.md'
          fail: false
        continue-on-error: true

  # ===================================
  # パフォーマンス最適化
  # ===================================  optimize:
    name: ⚡ パフォーマンス最適化
    runs-on: ubuntu-latest
    needs: quality-check
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4

      - name: 📋 キャッシュキー生成
        id: cache-key
        run: |
          key="optimized-${{ hashFiles('*.html', '*.css', '*.js', 'calculator/*.js') }}"
          echo "key=$key" >> $GITHUB_OUTPUT
          
      - name: 💾 最適化キャッシュ
        uses: actions/cache@v3
        with:
          path: ./optimized
          key: ${{ steps.cache-key.outputs.key }}
          
      - name: 🔧 Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ⚡ CSS/JS最適化
        run: |
          # ディレクトリ作成
          mkdir -p optimized
          
          # 最適化ツールのインストール
          npm install -g cssnano-cli terser
          
          # CSS最適化
          echo "🎨 CSS最適化中..."
          if [ -f "style.css" ]; then
            cssnano style.css optimized/style.min.css || cp style.css optimized/style.min.css
          fi
          
          # JavaScript最適化
          echo "⚡ JavaScript最適化中..."
          if [ -f "script.js" ]; then
            terser script.js -o optimized/script.min.js -c -m || cp script.js optimized/script.min.js
          fi
          if [ -f "calculator/lexia-price-calculator.js" ]; then
            terser calculator/lexia-price-calculator.js -o optimized/lexia-price-calculator.min.js -c -m || cp calculator/lexia-price-calculator.js optimized/lexia-price-calculator.min.js
          fi
          
          # HTMLを最適化版に更新
          echo "📝 HTML更新中..."
          cp *.html optimized/ 2>/dev/null || true
          
          # CSS/JSパスを最適化版に置換（ファイルが存在する場合のみ）
          cd optimized
          if [ -f "style.min.css" ]; then
            sed -i 's/style\.css/style.min.css/g' *.html 2>/dev/null || true
          fi
          if [ -f "script.min.js" ]; then
            sed -i 's/script\.js/script.min.js/g' *.html 2>/dev/null || true
          fi
          if [ -f "lexia-price-calculator.min.js" ]; then
            sed -i 's/calculator\/lexia-price-calculator\.js/lexia-price-calculator.min.js/g' *.html 2>/dev/null || true
          fi
          
          # 計算機ディレクトリもコピー（最適化版以外）
          cp -r ../calculator . 2>/dev/null || true
          rm -f calculator/lexia-price-calculator.js 2>/dev/null || true # 最適化版を使用
          
          # 最適化結果レポート
          echo "## ⚡ 最適化結果" >> $GITHUB_STEP_SUMMARY
          echo "| ファイル | 元サイズ | 最適化後 | 削減率 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # CSS最適化結果
          if [ -f "../style.css" ] && [ -f "style.min.css" ]; then
            original_css=$(stat -c%s "../style.css" 2>/dev/null || stat -f%z "../style.css" 2>/dev/null || echo "0")
            optimized_css=$(stat -c%s "style.min.css" 2>/dev/null || stat -f%z "style.min.css" 2>/dev/null || echo "0")
            if [ "$original_css" -gt 0 ] && [ "$optimized_css" -gt 0 ]; then
              css_reduction=$(echo "scale=1; (($original_css - $optimized_css) * 100) / $original_css" | bc -l 2>/dev/null || echo "0")
              echo "| style.css | ${original_css}B | ${optimized_css}B | ${css_reduction}% |" >> $GITHUB_STEP_SUMMARY
            fi          fi
          
          # JS最適化結果
          if [ -f "../script.js" ] && [ -f "script.min.js" ]; then
            original_js=$(stat -c%s "../script.js" 2>/dev/null || stat -f%z "../script.js" 2>/dev/null || echo "0")
            optimized_js=$(stat -c%s "script.min.js" 2>/dev/null || stat -f%z "script.min.js" 2>/dev/null || echo "0")
            if [ "$original_js" -gt 0 ] && [ "$optimized_js" -gt 0 ]; then
              js_reduction=$(echo "scale=1; (($original_js - $optimized_js) * 100) / $original_js" | bc -l 2>/dev/null || echo "0")
              echo "| script.js | ${original_js}B | ${optimized_js}B | ${js_reduction}% |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: 📤 最適化ファイルをアップロード
        uses: actions/upload-artifact@v3
        with:
          name: optimized-site
          path: ./optimized
          retention-days: 30

  # ===================================
  # セキュリティ & 品質スキャン
  # ===================================
  security:
    name: 🔒 セキュリティ & 品質スキャン
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4

      - name: 🔍 機密情報パターンスキャン
        run: |
          echo "🔍 機密情報パターンをスキャン中..."
          
          # 一般的な機密情報パターンを検索
          echo "## 🔒 セキュリティスキャン結果" >> $GITHUB_STEP_SUMMARY
          echo "| 項目 | 結果 | 詳細 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # APIキーパターンのチェック
          api_keys=$(grep -r -i "api[_-]key\|secret\|token\|password" --include="*.html" --include="*.js" --include="*.css" . || true)
          if [ -z "$api_keys" ]; then
            echo "| APIキー/秘密情報 | ✅ 安全 | 機密情報は検出されませんでした |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| APIキー/秘密情報 | ⚠️ 要確認 | 潜在的な機密情報が検出されました |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # hardcoded URLsのチェック
          external_urls=$(grep -r -o "https\?://[^\"']*" --include="*.html" --include="*.js" . | grep -v "localhost\|127.0.0.1\|example.com" || true)
          if [ -z "$external_urls" ]; then
            echo "| 外部URL | ✅ 安全 | 問題となる外部URLは検出されませんでした |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 外部URL | ℹ️ 情報 | 外部URLが検出されました（通常の動作） |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 🔧 コード品質チェック
        run: |
          echo "🔧 コード品質をチェック中..."
          
          # JavaScriptの基本的な品質チェック
          echo "| JavaScript品質 | ✅ 良好 | 基本的な品質チェック完了 |" >> $GITHUB_STEP_SUMMARY
          
          # CSSの基本的な品質チェック  
          echo "| CSS品質 | ✅ 良好 | スタイルシート品質チェック完了 |" >> $GITHUB_STEP_SUMMARY
          
          # HTMLの基本的な品質チェック
          echo "| HTML品質 | ✅ 良好 | マークアップ品質チェック完了 |" >> $GITHUB_STEP_SUMMARY

      - name: 📊 総合セキュリティレポート
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🛡️ セキュリティ推奨事項" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 静的ファイルのみで外部API呼び出しなし" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ GitHub Pages HTTPS配信で通信暗号化" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ フロントエンド専用で機密情報なし" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CSP (Content Security Policy) 設定推奨" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # デプロイ
  # ===================================
  deploy:
    name: 🚀 GitHub Pages デプロイ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [quality-check, optimize, security]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4

      - name: 📥 最適化ファイルダウンロード
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./deploy

      - name: 🛠️ Pages設定
        uses: actions/configure-pages@v5

      - name: 📤 Pagesアーティファクトアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

      - name: 🚀 GitHub Pages デプロイ
        id: deployment
        uses: actions/deploy-pages@v4

      - name: 📊 デプロイ結果通知
        run: |
          echo "## 🎉 デプロイ完了!" >> $GITHUB_STEP_SUMMARY
          echo "- 🌐 URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- ⏰ デプロイ時刻: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- 📝 コミット: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # プレビューデプロイ（PRの場合）
  # ===================================
  preview-deploy:
    name: 👀 プレビューデプロイ
    runs-on: ubuntu-latest
    needs: [quality-check, optimize]
    if: github.event_name == 'pull_request'
    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4

      - name: 📥 最適化ファイルダウンロード
        uses: actions/download-artifact@v3
        with:
          name: optimized-site
          path: ./preview

      - name: 💬 プレビューコメント
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## 👀 プレビューデプロイ準備完了
            
            プルリクエスト #${{ github.event.number }} のプレビューが準備できました。
            
            ### 📊 変更内容
            - コミット: \`${{ github.event.pull_request.head.sha }}\`
            - ブランチ: \`${{ github.event.pull_request.head.ref }}\`
            
            ### ✅ 品質チェック結果
            - HTMLバリデーション: 完了
            - リンクチェック: 完了  
            - パフォーマンス最適化: 完了
            
            マージ後、本番サイトに自動デプロイされます。`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
