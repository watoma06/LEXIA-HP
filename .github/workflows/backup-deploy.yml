# シンプルなバックアップデプロイワークフロー
# メインワークフローが失敗した場合のフォールバック
name: 🔧 Simple Deploy (Backup)

on:
  push:
    branches: ["main"]
    # メインワークフローが失敗した場合のみ実行
  workflow_dispatch:
    inputs:
      force_deploy:
        description: '強制デプロイ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'  # メインワークフローの失敗をトリガーとして追加
  workflow_run:
    workflows: ["🚀 Deploy LEXIA-HP Website"]
    types:
      - completed
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.event_name }}"
  cancel-in-progress: true

jobs:
  simple-deploy:
    name: 🚀 シンプルデプロイ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    # メインワークフローが失敗した場合または手動実行の場合のみ実行
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'push' && github.event.head_commit.message contains '[backup-deploy]')
    steps:
      - name: 📊 実行条件チェック
        run: |
          echo "🔍 実行条件チェック:"
          echo "Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "メインワークフロー結果: ${{ github.event.workflow_run.conclusion }}"
          fi
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "コミットメッセージ: ${{ github.event.head_commit.message }}"
          fi
          echo "バックアップデプロイを開始します..."
      - name: 📦 Checkout
        uses: actions/checkout@v4
        
      - name: 🛠️ Pages設定
        uses: actions/configure-pages@v5
        
      - name: 📤 アーティファクトアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
            - name: 🚀 GitHub Pages デプロイ
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ✅ デプロイ完了
        run: |
          echo "🎉 バックアップデプロイ完了!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "実行理由: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "⚠️ メインワークフローの失敗によるフォールバックデプロイでした"
          fi
          
      - name: 🚨 失敗時通知
        if: failure()
        run: |
          echo "❌ バックアップデプロイが失敗しました"
          echo "手動での確認が必要です"
          exit 1
